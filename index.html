<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Kaylyn Math ‚Äî Studio</title>
<style>
  /* =========================
     Studio Design System (v2)
     - Apple-clean + vibrant accents
  ========================== */
  :root{
    --bg0:#060816;
    --bg1:#070a12;

    --panel:rgba(255,255,255,.075);
    --panel2:rgba(255,255,255,.045);
    --border:rgba(255,255,255,.12);
    --shadow: 0 24px 70px rgba(0,0,0,.45);

    --text:#eef2ff;
    --muted:rgba(238,242,255,.70);
    --muted2:rgba(238,242,255,.52);

    /* Accent palette */
    --a1:#5eead4; /* mint */
    --a2:#a78bfa; /* purple */
    --a3:#60a5fa; /* blue */
    --a4:#fb7185; /* pink */
    --a5:#fbbf24; /* amber */
    --good:#34d399;
    --bad:#fb7185;
    --warn:#fbbf24;

    --radius: 22px;
    --radius2: 16px;
    --ring: 0 0 0 4px rgba(94,234,212,.18);

    --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
  }

  [data-theme="light"]{
    --bg0:#f4f7ff;
    --bg1:#ffffff;
    --panel:rgba(15,23,42,.06);
    --panel2:rgba(15,23,42,.045);
    --border:rgba(15,23,42,.10);
    --shadow: 0 18px 55px rgba(2,6,23,.12);

    --text:#0b1226;
    --muted:rgba(11,18,38,.70);
    --muted2:rgba(11,18,38,.52);
    --ring: 0 0 0 4px rgba(96,165,250,.18);
  }

  /* Accent themes */
  [data-accent="mint"]{ --a1:#5eead4; --a2:#a78bfa; --a3:#60a5fa; --a4:#fb7185; --a5:#fbbf24; }
  [data-accent="sunset"]{ --a1:#fb7185; --a2:#fbbf24; --a3:#60a5fa; --a4:#a78bfa; --a5:#34d399; }
  [data-accent="ocean"]{ --a1:#60a5fa; --a2:#5eead4; --a3:#a78bfa; --a4:#fbbf24; --a5:#fb7185; }

  *{ box-sizing:border-box; }
  html,body{ height:100%; }
  body{
    margin:0;
    font-family: var(--font);
    color: var(--text);
    background:
      radial-gradient(900px 650px at 14% 6%, color-mix(in srgb, var(--a1) 18%, transparent), transparent 60%),
      radial-gradient(900px 650px at 86% 0%, color-mix(in srgb, var(--a2) 18%, transparent), transparent 58%),
      radial-gradient(900px 650px at 55% 110%, color-mix(in srgb, var(--a3) 12%, transparent), transparent 60%),
      linear-gradient(180deg, var(--bg0), var(--bg1));
    overflow-x:hidden;
  }
  a{ color:inherit; text-decoration:none; }
  .wrap{ max-width: 1320px; margin:0 auto; padding: 18px; }
  .glass{
    border:1px solid var(--border);
    background: linear-gradient(180deg, rgba(255,255,255,.09), rgba(255,255,255,.045));
    box-shadow: var(--shadow);
    border-radius: var(--radius);
    backdrop-filter: blur(10px);
  }

  /* Top bar */
  .top{ padding: 16px 16px 12px; }
  .topRow{
    display:flex; align-items:flex-start; justify-content:space-between;
    gap:14px; flex-wrap:wrap;
  }
  .brand{ display:flex; gap:12px; align-items:flex-start; min-width: 280px; }
  .logo{
    width:44px;height:44px;border-radius: 16px;
    border:1px solid var(--border);
    background: linear-gradient(135deg,
      color-mix(in srgb, var(--a1) 35%, transparent),
      color-mix(in srgb, var(--a2) 35%, transparent)
    );
    display:grid; place-items:center;
    font-weight:950;
    letter-spacing:.5px;
    box-shadow: 0 14px 40px rgba(0,0,0,.22);
  }
  .brand h1{ margin:0; font-size: 18px; font-weight: 950; letter-spacing:.2px; }
  .brand p{ margin:4px 0 0; color: var(--muted); line-height:1.35; font-size: 13px; }

  .pillRow{ display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end; align-items:center; }
  .pill{
    display:flex; gap:8px; align-items:center;
    padding: 8px 10px;
    border-radius: 999px;
    border:1px solid var(--border);
    background: var(--panel2);
    color: var(--muted);
    font-size: 13px;
    white-space:nowrap;
  }
  .pill strong{ color: var(--text); }

  .btn{
    border:1px solid var(--border);
    background: var(--panel);
    color: var(--text);
    padding:10px 12px;
    border-radius: 14px;
    font-weight: 950;
    cursor:pointer;
    transition: transform .14s ease, border-color .14s ease, background .14s ease;
    user-select:none;
  }
  .btn:hover{ transform: translateY(-1px); border-color: color-mix(in srgb, var(--a1) 40%, var(--border)); }
  .btn:active{ transform: translateY(0px); }
  .btn.primary{
    background: linear-gradient(90deg,
      color-mix(in srgb, var(--a1) 18%, transparent),
      color-mix(in srgb, var(--a2) 18%, transparent),
      color-mix(in srgb, var(--a3) 18%, transparent)
    );
    border-color: color-mix(in srgb, var(--a1) 22%, var(--border));
  }
  .btn.ghost{ background: transparent; }
  .btn.small{ padding:8px 10px; border-radius: 12px; font-size: 12px; }
  .btn.bad:hover{ border-color: rgba(251,113,133,.55); }
  .btn.good:hover{ border-color: rgba(52,211,153,.55); }

  .bar{
    margin-top: 12px;
    height: 12px;
    border-radius: 999px;
    border: 1px solid var(--border);
    background: var(--panel2);
    overflow:hidden;
  }
  .bar > div{
    height:100%;
    width:0%;
    background: linear-gradient(90deg, var(--a1), var(--a2), var(--a3));
    border-radius: 999px;
    transition: width .35s ease;
  }

  .grid{
    margin-top: 14px;
    display:grid;
    grid-template-columns: 380px 1fr;
    gap: 14px;
  }
  @media (max-width: 980px){
    .grid{ grid-template-columns: 1fr; }
  }

  .panel{ padding: 14px; }
  .panelHead{
    display:flex; align-items:center; justify-content:space-between;
    gap: 10px; margin-bottom: 10px;
  }
  .panelHead h2{
    margin:0;
    font-size: 12px;
    letter-spacing: .7px;
    text-transform: uppercase;
    color: var(--muted);
  }
  .list{
    max-height: calc(100vh - 240px);
    overflow:auto;
    padding-right: 4px;
  }

  .wkBtn{
    width:100%;
    border: 1px solid var(--border);
    background: rgba(255,255,255,.05);
    border-radius: 18px;
    padding: 12px 12px;
    text-align:left;
    cursor:pointer;
    margin-bottom: 10px;
    transition: transform .14s ease, border-color .14s ease, background .14s ease;
    display:flex; align-items:flex-start; justify-content:space-between; gap:10px;
  }
  .wkBtn:hover{ transform: translateY(-1px); border-color: color-mix(in srgb, var(--a2) 32%, var(--border)); }
  .wkBtn.active{
    border-color: color-mix(in srgb, var(--a1) 50%, var(--border));
    background: rgba(255,255,255,.075);
  }
  .wkLeft{ display:flex; flex-direction:column; gap:4px; }
  .wkTitle{ font-weight: 950; }
  .wkSub{ font-size: 12px; color: var(--muted); line-height: 1.25; }
  .wkRight{ display:flex; flex-direction:column; gap:6px; align-items:flex-end; }

  .badge{
    font-size: 11px;
    padding: 4px 8px;
    border-radius: 999px;
    border: 1px solid var(--border);
    background: var(--panel2);
    color: var(--muted);
    white-space:nowrap;
  }
  .badge.done{ color: rgba(52,211,153,.95); border-color: rgba(52,211,153,.35); }
  .badge.ip{ color: rgba(251,191,36,.95); border-color: rgba(251,191,36,.35); }
  .badge.m0{ color: rgba(148,163,184,.95); }
  .badge.m1{ color: color-mix(in srgb, var(--a3) 90%, white); border-color: color-mix(in srgb, var(--a3) 35%, var(--border)); }
  .badge.m2{ color: color-mix(in srgb, var(--a2) 90%, white); border-color: color-mix(in srgb, var(--a2) 35%, var(--border)); }
  .badge.m3{ color: color-mix(in srgb, var(--a1) 90%, white); border-color: color-mix(in srgb, var(--a1) 35%, var(--border)); }

  .mainHead{
    display:flex; align-items:flex-start; justify-content:space-between;
    gap: 12px; flex-wrap:wrap;
    margin-bottom: 12px;
  }
  .path{ color: var(--muted2); font-size: 12px; }
  .hTitle{ margin: 2px 0 0; font-size: 18px; font-weight: 950; }
  .desc{ margin: 6px 0 0; color: var(--muted); line-height: 1.35; font-size: 13px; }
  .krow{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-top: 10px; }

  .card{
    border:1px solid var(--border);
    background: rgba(255,255,255,.04);
    border-radius: var(--radius);
    padding: 14px;
    margin-bottom: 12px;
  }

  .two{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
  }
  @media(max-width: 860px){
    .two{ grid-template-columns: 1fr; }
  }

  .q{
    border:1px solid var(--border);
    background: rgba(255,255,255,.03);
    border-radius: var(--radius);
    padding: 14px;
    position:relative;
    overflow:hidden;
  }
  .q::before{
    content:"";
    position:absolute; inset:-2px;
    background: radial-gradient(260px 120px at 15% 0%, color-mix(in srgb, var(--a1) 10%, transparent), transparent 60%);
    pointer-events:none;
    opacity:.75;
  }
  .q > *{ position:relative; }

  .qTop{
    display:flex;
    align-items:flex-start;
    justify-content:space-between;
    gap:10px;
  }
  .qTitle{ font-weight: 950; }
  .qMeta{ margin-top: 4px; color: var(--muted); font-size: 12px; }

  .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-top: 10px; }
  input[type="text"], input[type="number"]{
    background: rgba(0,0,0,.14);
    border:1px solid var(--border);
    color: var(--text);
    padding: 10px 12px;
    border-radius: 14px;
    outline:none;
    min-width: 170px;
  }
  input:focus{ box-shadow: var(--ring); border-color: color-mix(in srgb, var(--a1) 45%, var(--border)); }

  textarea{
    width:100%;
    min-height: 88px;
    resize: vertical;
    background: rgba(0,0,0,.14);
    border:1px solid var(--border);
    color: var(--text);
    padding: 10px 12px;
    border-radius: 14px;
    outline:none;
    margin-top: 8px;
  }

  .optGrid{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
    margin-top: 10px;
  }
  @media(max-width: 600px){ .optGrid{ grid-template-columns: 1fr; } }

  .opt{
    border:1px solid var(--border);
    background: rgba(255,255,255,.03);
    padding: 10px 12px;
    border-radius: 14px;
    cursor:pointer;
    font-weight: 900;
    transition: transform .14s ease, border-color .14s ease;
  }
  .opt:hover{ transform: translateY(-1px); border-color: color-mix(in srgb, var(--a1) 30%, var(--border)); }
  .opt.sel{ border-color: color-mix(in srgb, var(--a2) 55%, var(--border)); }

  .feedback{
    display:none;
    margin-top: 10px;
    padding: 10px 12px;
    border-radius: 14px;
    border:1px solid var(--border);
    background: rgba(255,255,255,.03);
    color: var(--muted);
    line-height: 1.35;
  }
  .feedback.good{
    display:block;
    border-color: rgba(52,211,153,.35);
    background: rgba(52,211,153,.06);
    color: rgba(52,211,153,.95);
  }
  .feedback.bad{
    display:block;
    border-color: rgba(251,113,133,.35);
    background: rgba(251,113,133,.06);
    color: rgba(251,113,133,.95);
  }
  .feedback.warn{
    display:block;
    border-color: rgba(251,191,36,.35);
    background: rgba(251,191,36,.06);
    color: rgba(251,191,36,.95);
  }
  .hint{
    display:none;
    margin-top: 8px;
    color: var(--muted);
    font-size: 13px;
  }
  .tiny{ font-size: 12px; color: var(--muted); }
  .hr{ height:1px; background: rgba(255,255,255,.10); margin: 12px 0; }

  /* Visual widgets */
  .viz{
    margin-top:10px;
    border:1px solid var(--border);
    background: rgba(255,255,255,.03);
    border-radius: 16px;
    padding:10px;
  }
  .svg{
    width:100%;
    height:auto;
    display:block;
  }
  .chip{
    display:inline-flex; align-items:center; gap:6px;
    padding:6px 10px;
    border-radius:999px;
    border:1px solid var(--border);
    background: rgba(255,255,255,.04);
    font-size:12px;
    color: var(--muted);
  }
  .dot{
    width:10px;height:10px;border-radius:999px;
    background: var(--a3);
    box-shadow: 0 0 0 3px rgba(96,165,250,.12);
  }

  /* Confetti */
  .confetti{
    position:fixed; inset:0;
    pointer-events:none;
    overflow:hidden;
    display:none;
  }
  .confetti.on{ display:block; }
  .c{
    position:absolute;
    width:10px;height:14px;
    border-radius: 4px;
    opacity:.95;
    transform: translateY(-20px) rotate(0deg);
    animation: fall 900ms ease-in forwards;
  }
  @keyframes fall{
    to{ transform: translateY(110vh) rotate(540deg); opacity:0.9; }
  }
</style>
</head>

<body>
<div class="wrap">
  <section class="glass top">
    <div class="topRow">
      <div class="brand">
        <div class="logo">K</div>
        <div>
          <h1>Kaylyn Math ‚Äî Studio</h1>
          <p>Grade 3+ ‚Ä¢ 20-week track ‚Ä¢ daily practice ‚Ä¢ mini-quizzes ‚Ä¢ visuals ‚Ä¢ robust answer checking</p>
        </div>
      </div>
      <div class="pillRow">
        <div class="pill">Weeks done: <strong id="doneLabel">0/20</strong></div>
        <div class="pill">XP: <strong id="xpLabel">0</strong></div>
        <div class="pill">Streak: <strong id="streakLabel">0</strong></div>

        <button class="btn small" id="themeBtn">Theme</button>
        <button class="btn small" id="accentBtn">Colors</button>

        <button class="btn small" id="exportBtn">Export</button>
        <button class="btn small" id="importBtn">Import</button>
        <button class="btn small bad" id="resetBtn">Reset</button>
      </div>
    </div>
    <div class="bar"><div id="progressBar"></div></div>
  </section>

  <section class="grid">
    <aside class="glass panel">
      <div class="panelHead">
        <h2>Modes</h2>
        <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end;">
          <button class="btn small ghost" id="courseBtn">Course</button>
          <button class="btn small ghost" id="dailyBtn">Daily</button>
          <button class="btn small ghost" id="quizBtn">Mini-Quiz</button>
          <button class="btn small ghost" id="dashboardBtn">Parent</button>
        </div>
      </div>
      <div class="list" id="weekList"></div>
    </aside>

    <main class="glass panel">
      <div class="mainHead">
        <div>
          <div class="path" id="pathLabel">Course</div>
          <div class="hTitle" id="titleLabel">Welcome</div>
          <div class="desc" id="descLabel">Pick a week or use Daily / Mini-Quiz. Everything saves on this device.</div>
          <div class="krow">
            <div class="pill">Skill: <strong id="skillLabel">‚Äî</strong></div>
            <div class="pill">Mastery: <strong id="masteryLabel">‚Äî</strong></div>
            <div class="pill">Seed: <strong id="seedLabel">‚Äî</strong></div>
          </div>
        </div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end;">
          <div class="badge" id="weekStatus">‚Äî</div>
          <button class="btn small primary" id="newSetBtn" title="New variations">New set</button>
        </div>
      </div>

      <div class="card" id="messageCard">
        <div class="krow" style="justify-content:space-between">
          <div class="chip"><span class="dot"></span> Forgiving input: x, √ó, *, √∑, / ‚Ä¢ ignores spaces/commas</div>
          <div class="chip"><span class="dot" style="background:var(--a1)"></span> After 1 wrong: hint ‚Ä¢ After 2 wrong: steps</div>
        </div>
      </div>

      <div class="two" id="qWrap"></div>

      <div class="card" id="explainCard" style="display:none">
        <div class="hTitle">‚úçÔ∏è Explain your thinking (2‚Äì5 sentences)</div>
        <div class="desc">This is how top students learn: explain clearly, then improve.</div>
        <textarea id="explainBox" placeholder="I started by‚Ä¶ Then I noticed‚Ä¶ I checked by‚Ä¶"></textarea>
        <div class="krow" style="justify-content:space-between">
          <button class="btn primary" id="saveExplainBtn">Save</button>
          <div class="tiny" id="explainSaved">Not saved</div>
        </div>
      </div>

      <div class="card" id="quizCard" style="display:none">
        <div class="hTitle">‚è±Ô∏è Mini-Quiz</div>
        <div class="desc">10 questions ‚Ä¢ mixed skills ‚Ä¢ score + time. Hit Start to generate.</div>
        <div class="krow" style="justify-content:space-between">
          <div class="pill">Time: <strong id="quizTime">0:00</strong></div>
          <div class="pill">Score: <strong id="quizScore">0/10</strong></div>
          <button class="btn primary" id="quizStartBtn">Start</button>
        </div>
      </div>

      <div class="card" id="dashboard" style="display:none">
        <div class="hTitle">üìä Parent dashboard</div>
        <div class="desc">Accuracy, time, and weakest skills.</div>
        <div class="hr"></div>
        <div class="krow" id="dashStats"></div>
        <div class="hr"></div>
        <div class="tiny" id="dashWeak"></div>
      </div>
    </main>
  </section>
</div>

<div class="confetti" id="confetti"></div>

<script>
/* ============================================================
   Kaylyn Math ‚Äî Studio v2
   - 10 problems/week + infinite variations
   - Daily practice + Mini-Quiz
   - Visual widgets (array, number line, fraction bar)
   - Robust checking + better feedback
============================================================ */

/* ---------- Persistence ---------- */
const STORE_KEY = "kaylyn_math_studio_v2";
const now = () => Date.now();

const defaultState = () => ({
  theme: "dark",
  accent: "mint",
  mode: "course", // course | daily | quiz
  currentWeek: 0,

  weeks: {},      // weekIndex -> { setCounter, attempts, explain, timeMs, stats }
  mastery: {},    // skillId -> { xp, level, lastSeen }
  totalXp: 0,
  streak: 0,
  streakBest: 0,
  doneWeeks: {},

  events: [],     // answer logs
  quiz: { active:false, startedAt:0, seed:"", score:0, total:10, qids:[] }
});

let state = loadState();
function loadState(){
  try{
    const raw = localStorage.getItem(STORE_KEY);
    if(!raw) return defaultState();
    const s = JSON.parse(raw);
    const d = defaultState();
    const merged = { ...d, ...s };
    merged.weeks = s.weeks || {};
    merged.mastery = s.mastery || {};
    merged.doneWeeks = s.doneWeeks || {};
    merged.events = s.events || [];
    merged.quiz = { ...d.quiz, ...(s.quiz||{}) };
    return merged;
  }catch{
    return defaultState();
  }
}
function saveState(){ localStorage.setItem(STORE_KEY, JSON.stringify(state)); }
function logEvent(type, detail){
  state.events.push({ t: now(), type, detail });
  if(state.events.length > 600) state.events = state.events.slice(-450);
  saveState();
}

/* ---------- Theme + Accent ---------- */
const themeBtn = document.getElementById("themeBtn");
const accentBtn = document.getElementById("accentBtn");

function applyTheme(){
  document.documentElement.setAttribute("data-theme", state.theme === "light" ? "light" : "dark");
  document.documentElement.setAttribute("data-accent", state.accent || "mint");
}
themeBtn.addEventListener("click", ()=>{
  state.theme = (state.theme === "light") ? "dark" : "light";
  saveState(); applyTheme();
});
accentBtn.addEventListener("click", ()=>{
  const order = ["mint","sunset","ocean"];
  const i = order.indexOf(state.accent||"mint");
  state.accent = order[(i+1)%order.length];
  saveState(); applyTheme();
});
applyTheme();

/* ---------- Seeded RNG ---------- */
function xmur3(str){
  let h = 1779033703 ^ str.length;
  for(let i=0;i<str.length;i++){
    h = Math.imul(h ^ str.charCodeAt(i), 3432918353);
    h = (h << 13) | (h >>> 19);
  }
  return function(){
    h = Math.imul(h ^ (h >>> 16), 2246822507);
    h = Math.imul(h ^ (h >>> 13), 3266489909);
    return (h ^= (h >>> 16)) >>> 0;
  };
}
function mulberry32(a){
  return function(){
    let t = a += 0x6D2B79F5;
    t = Math.imul(t ^ (t >>> 15), t | 1);
    t ^= t + Math.imul(t ^ (t >>> 7), t | 61);
    return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
  };
}
function seededRand(seedStr){
  const seed = xmur3(seedStr)();
  return mulberry32(seed);
}
function rInt(r,a,b){ return Math.floor(r()*(b-a+1))+a; }
function pick(r,arr){ return arr[Math.floor(r()*arr.length)]; }
function shuffle(r, arr){
  const a = arr.slice();
  for(let i=a.length-1;i>0;i--){
    const j = Math.floor(r()*(i+1));
    [a[i],a[j]] = [a[j],a[i]];
  }
  return a;
}

/* ---------- Parsing + Checkers ---------- */
function normalizeExpr(s){
  return String(s ?? "")
    .trim()
    .replace(/[,\s]+/g, "")     // ignore commas/spaces
    .replace(/[xX√ó]/g, "*")
    .replace(/√∑/g, "/")
    .replace(/[‚Äì‚Äî]/g, "-");
}
function isSafeExpr(s){ return /^[0-9+\-*/().]+$/.test(s); }
function countNumbersInExpr(s){
  const m = s.match(/\d+(\.\d+)?/g);
  return m ? m.length : 0;
}
function evalExprSafe(expr){
  const s = normalizeExpr(expr);
  if(!s) throw new Error("empty");
  if(!isSafeExpr(s)) throw new Error("unsafe");
  if(s.includes("**")) throw new Error("unsafe");
  // eslint-disable-next-line no-new-func
  const fn = Function(`"use strict"; return (${s});`);
  const v = fn();
  if(!Number.isFinite(v)) throw new Error("notfinite");
  return v;
}
function approxEq(a,b,eps=1e-9){ return Math.abs(a-b) < eps; }

function parseFraction(s){
  const t = String(s ?? "").trim();
  if(!t) return null;

  const mixed = t.match(/^(-?\d+)\s+(\d+)\s*\/\s*(\d+)$/);
  if(mixed){
    const whole = Number(mixed[1]);
    const num = Number(mixed[2]);
    const den = Number(mixed[3]);
    if(den===0) return null;
    const sign = whole < 0 ? -1 : 1;
    return (Math.abs(whole) + num/den) * sign;
  }

  const frac = t.match(/^(-?\d+)\s*\/\s*(\d+)$/);
  if(frac){
    const num = Number(frac[1]);
    const den = Number(frac[2]);
    if(den===0) return null;
    return num/den;
  }

  const n = Number(t);
  if(Number.isFinite(n)) return n;
  return null;
}

const Checkers = {
  integer(expected){
    return (raw) => {
      const t = String(raw ?? "").trim();
      if(!t) return { ok:false, msg:"Enter an answer." };
      if(!/^-?\d+$/.test(t)) return { ok:false, msg:"Enter a whole number." };
      const n = Number(t);
      return n===expected ? { ok:true } : { ok:false, msg:`Not quite. Try again.` };
    };
  },
  number(expected, eps=1e-9){
    return (raw)=>{
      const t = String(raw ?? "").trim();
      if(!t) return { ok:false, msg:"Enter an answer." };
      const n = Number(t);
      if(!Number.isFinite(n)) return { ok:false, msg:"Enter a number." };
      return Math.abs(n-expected) <= eps ? { ok:true } : { ok:false, msg:"Not quite. Try again." };
    };
  },
  fractionEquals(expected){
    return (raw)=>{
      const v = parseFraction(raw);
      if(v===null) return { ok:false, msg:"Type a fraction like 3/4 (or decimal)." };
      return approxEq(v, expected, 1e-9) ? { ok:true } : { ok:false, msg:"Not quite. Check numerator/denominator." };
    };
  },
  exprEquals(target, exactlyNums=null){
    return (raw)=>{
      const s = normalizeExpr(raw);
      if(!s) return { ok:false, msg:"Type an expression like (5+7)*2." };
      if(!isSafeExpr(s)) return { ok:false, msg:"Use only numbers and + - √ó √∑ ( )" };
      if(exactlyNums!=null){
        const c = countNumbersInExpr(s);
        if(c !== exactlyNums) return { ok:false, msg:`Use exactly ${exactlyNums} numbers (you used ${c}).` };
      }
      try{
        const val = evalExprSafe(s);
        if(approxEq(val, target, 1e-9)) return { ok:true };
        return { ok:false, msg:`That equals ${val}, not ${target}.` };
      }catch{
        return { ok:false, msg:"Invalid expression. Check parentheses/operators." };
      }
    };
  }
};

/* ---------- Confetti ---------- */
const confettiEl = document.getElementById("confetti");
function popConfetti(){
  confettiEl.innerHTML = "";
  confettiEl.classList.add("on");
  const colors = ["var(--a1)","var(--a2)","var(--a3)","var(--a4)","var(--a5)"];
  for(let i=0;i<28;i++){
    const d = document.createElement("div");
    d.className = "c";
    d.style.left = Math.random()*100 + "vw";
    d.style.top = "-20px";
    d.style.background = colors[Math.floor(Math.random()*colors.length)];
    d.style.animationDuration = (650 + Math.random()*700) + "ms";
    confettiEl.appendChild(d);
  }
  setTimeout(()=>confettiEl.classList.remove("on"), 980);
}

/* ---------- Visual Widgets ---------- */
function svgArrayModel(rows, cols){
  const cell = 18, gap = 4;
  const w = cols*(cell+gap)+gap, h = rows*(cell+gap)+gap;
  let rects = "";
  for(let r=0;r<rows;r++){
    for(let c=0;c<cols;c++){
      const x = gap + c*(cell+gap);
      const y = gap + r*(cell+gap);
      rects += `<rect x="${x}" y="${y}" width="${cell}" height="${cell}" rx="4" fill="rgba(96,165,250,.18)" stroke="rgba(255,255,255,.12)" />`;
    }
  }
  return `<svg class="svg" viewBox="0 0 ${w} ${h}" xmlns="http://www.w3.org/2000/svg">
    ${rects}
  </svg>`;
}

function svgNumberLine(min, max, mark){
  const W=520, H=70, pad=28;
  const lineY=40;
  const x = (v)=> pad + ((v-min)/(max-min))*(W-2*pad);
  let ticks = "";
  for(let v=min; v<=max; v++){
    const tx = x(v);
    const big = (v%5===0);
    ticks += `<line x1="${tx}" y1="${lineY-(big?10:6)}" x2="${tx}" y2="${lineY+(big?10:6)}" stroke="rgba(255,255,255,.20)" />`;
    if(big){
      ticks += `<text x="${tx}" y="${lineY+26}" text-anchor="middle" font-size="12" fill="rgba(238,242,255,.70)">${v}</text>`;
    }
  }
  const mx = x(mark);
  return `<svg class="svg" viewBox="0 0 ${W} ${H}" xmlns="http://www.w3.org/2000/svg">
    <line x1="${pad}" y1="${lineY}" x2="${W-pad}" y2="${lineY}" stroke="rgba(255,255,255,.25)" stroke-width="2"/>
    ${ticks}
    <circle cx="${mx}" cy="${lineY}" r="8" fill="rgba(94,234,212,.85)" />
  </svg>`;
}

function svgFractionBar(num, den){
  const W=520, H=70, pad=18;
  const barX=pad, barY=24, barW=W-2*pad, barH=18;
  const segW = barW/den;
  let segs="";
  for(let i=0;i<den;i++){
    const x = barX + i*segW;
    const fill = i < num ? "rgba(167,139,250,.35)" : "rgba(255,255,255,.06)";
    segs += `<rect x="${x}" y="${barY}" width="${segW-2}" height="${barH}" rx="6" fill="${fill}" stroke="rgba(255,255,255,.12)" />`;
  }
  return `<svg class="svg" viewBox="0 0 ${W} ${H}" xmlns="http://www.w3.org/2000/svg">
    ${segs}
    <text x="${W/2}" y="${barY+barH+20}" text-anchor="middle" font-size="12" fill="rgba(238,242,255,.70)">${num}/${den}</text>
  </svg>`;
}

/* ---------- Course Map ---------- */
const Weeks = [
  { title:"Week 1 ‚Äî Flexible Numbers", desc:"Expressions, factors, mental math.", skill:"flex" },
  { title:"Week 2 ‚Äî Patterns & Rules", desc:"Find rules, extend, create.", skill:"patterns" },
  { title:"Week 3 ‚Äî Add/Sub Structure", desc:"Regrouping, compensation.", skill:"addsub" },
  { title:"Week 4 ‚Äî Multiplication", desc:"Multi-digit strategies + arrays.", skill:"mult" },
  { title:"Week 5 ‚Äî Division", desc:"Quotient & remainder meaning.", skill:"div" },
  { title:"Week 6 ‚Äî Word Problems", desc:"Translate words to math.", skill:"word" },
  { title:"Week 7 ‚Äî Estimation", desc:"Bounds + sanity checks.", skill:"estimate" },
  { title:"Week 8 ‚Äî Time", desc:"Elapsed time + schedules.", skill:"time" },
  { title:"Week 9 ‚Äî Money", desc:"Totals + change.", skill:"money" },
  { title:"Week10 ‚Äî Fractions Intro", desc:"Fractions as numbers.", skill:"frac_intro" },
  { title:"Week11 ‚Äî Equivalent Fractions", desc:"Scale & simplify + bars.", skill:"frac_equiv" },
  { title:"Week12 ‚Äî Compare Fractions", desc:"Compare smartly.", skill:"frac_comp" },
  { title:"Week13 ‚Äî Area & Perimeter", desc:"Rectangles & reasoning.", skill:"area" },
  { title:"Week14 ‚Äî Geometry", desc:"Angles, symmetry.", skill:"geo" },
  { title:"Week15 ‚Äî Data", desc:"Read charts/tables.", skill:"data" },
  { title:"Week16 ‚Äî Early Algebra", desc:"Unknowns & balance.", skill:"alg" },
  { title:"Week17 ‚Äî Mixed Review", desc:"Interleaving for mastery.", skill:"review" },
  { title:"Week18 ‚Äî Challenges", desc:"Harder puzzles.", skill:"challenge" },
  { title:"Week19 ‚Äî Teach Back", desc:"Explain like a teacher.", skill:"teach" },
  { title:"Week20 ‚Äî Capstone", desc:"Create + solve problems.", skill:"capstone" },
];

/* ---------- Mastery ---------- */
function getMastery(skillId){
  if(!state.mastery[skillId]) state.mastery[skillId] = { xp:0, level:0, lastSeen:0 };
  return state.mastery[skillId];
}
function masteryLevelFromXp(xp){
  if(xp >= 300) return 3;
  if(xp >= 160) return 2;
  if(xp >= 70)  return 1;
  return 0;
}
function masteryBadge(level){
  if(level>=3) return { text:"Mastery 3", cls:"m3" };
  if(level===2) return { text:"Mastery 2", cls:"m2" };
  if(level===1) return { text:"Mastery 1", cls:"m1" };
  return { text:"Mastery 0", cls:"m0" };
}
function award(skillId, correct){
  const m = getMastery(skillId);
  if(correct){
    state.streak = (state.streak||0) + 1;
    state.streakBest = Math.max(state.streakBest||0, state.streak);
    const gain = 8 + Math.min(12, state.streak); // 9..20
    m.xp += gain;
    state.totalXp += gain;
    m.level = masteryLevelFromXp(m.xp);
    m.lastSeen = now();
  }else{
    state.streak = 0;
  }
  saveState();
}

/* ---------- Week state ---------- */
function weekState(i){
  if(!state.weeks[i]){
    state.weeks[i] = { setCounter:0, attempts:{}, explain:"", timeMs:0, stats:{correct:0, wrong:0} };
  }
  const ws = state.weeks[i];
  ws.attempts ||= {};
  ws.stats ||= {correct:0, wrong:0};
  return ws;
}
function dayKey(){
  const d = new Date();
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,'0');
  const dd = String(d.getDate()).padStart(2,'0');
  return `${y}-${m}-${dd}`;
}
function weekSeed(i){
  const ws = weekState(i);
  return `w${i}-${dayKey()}-set${ws.setCounter||0}`;
}
function dailySeed(){
  return `daily-${dayKey()}-set0`;
}
function quizSeed(){
  return `quiz-${dayKey()}-${Math.floor((state.quiz.startedAt||now())/1000)}`;
}

/* ---------- Generators (10 questions/week) ---------- */
function q(id, type, skillId, prompt, hint, solution, checker, vizHtml=null, options=null, correctIndex=null){
  return { id, type, skillId, prompt, hint, solution, checker, vizHtml, options, correctIndex };
}

function genFlex(r){
  const target = pick(r, [18,24,28,30,36,42]);
  const nums = 3;
  const n = target;
  // factor pairs question
  let pairCount=0;
  for(let a=1;a<=Math.floor(Math.sqrt(n));a++) if(n%a===0) pairCount++;

  return [
    q("exprTarget","expr","flex",
      `Make <b>${target}</b> using exactly <b>${nums}</b> numbers.`,
      `Try (a+b)√óc or a√ób¬±c. Example: (5+7)√ó2.`,
      `Example answers: 8√ó3√ó1, (5+7)√ó2, (10-2)√ó3 (varies by target).`,
      Checkers.exprEquals(target, nums)
    ),
    q("pairCount","integer","flex",
      `How many factor pairs does <b>${target}</b> have?`,
      `Count divisors up to ‚àön; each divisor gives one pair.`,
      `Count a=1..‚àö${target} where ${target}%a=0 ‚Üí ${pairCount} pairs.`,
      Checkers.integer(pairCount)
    )
  ];
}

function genPatterns(r){
  const a = rInt(r, 2, 9);
  const mul = pick(r, [2,3]);
  const add = rInt(r, 1, 6);
  const seq = [a];
  for(let i=0;i<4;i++) seq.push(seq[seq.length-1]*mul + add);
  return [
    q("next","integer","patterns",
      `Pattern: <b>${seq[0]} ‚Üí ${seq[1]} ‚Üí ${seq[2]} ‚Üí ${seq[3]} ‚Üí ?</b>`,
      `Try √ó${mul} then +${add}.`,
      `Rule: √ó${mul} then +${add}. Next is ${seq[4]}.`,
      Checkers.integer(seq[4])
    ),
    q("rule","text","patterns",
      `Write the rule in one sentence.`,
      `Example: ‚ÄúMultiply by __ then add __.‚Äù`,
      `A strong answer: ‚ÄúMultiply by ${mul} then add ${add}.‚Äù`,
      (raw)=> String(raw??"").trim().length>=12 ? ({ok:true}) : ({ok:false,msg:"Write one full sentence."})
    )
  ];
}

function genAddSub(r){
  const a = rInt(r, 1200, 9800);
  const b = rInt(r, 120, 3900);
  const op = pick(r, ["+","-"]);
  const ans = op==="+" ? a+b : a-b;
  const prompt = op==="+" ? `Compute: <b>${a} + ${b}</b>` : `Compute: <b>${a} ‚àí ${b}</b>`;
  const min = Math.min(a,b), max = Math.max(a,b);
  const mark = max - min; // little number line ‚Äúdifference‚Äù visualization for subtraction
  const viz = op==="-" ? `<div class="viz">${svgNumberLine(0, 50, Math.min(50, mark%51))}</div>` : null;

  return [
    q("calc","integer","addsub", prompt,
      op==="+" ? "Add place values with regrouping." : "Subtract with borrowing (regrouping).",
      `Answer: ${ans}.`,
      Checkers.integer(ans),
      viz
    ),
    q("check","mcq","addsub",
      `Fastest check for your answer?`,
      `Inverse operation catches mistakes.`,
      `Use inverse: subtraction checks addition, addition checks subtraction.`,
      null,
      null,
      ["Use inverse operation","Guess","Do nothing","Only calculator"],
      0
    )
  ];
}

function genMult(r){
  const rows = rInt(r, 3, 9);
  const cols = rInt(r, 4, 12);
  const ans = rows*cols;
  const a = rInt(r, 1200, 9999);
  const b = rInt(r, 12, 99);
  const ans2 = a*b;

  return [
    q("array","integer","mult",
      `Array model: <b>${rows}</b> rows and <b>${cols}</b> columns. How many total?`,
      `Multiply rows √ó columns.`,
      `${rows}√ó${cols}=${ans}.`,
      Checkers.integer(ans),
      `<div class="viz">${svgArrayModel(rows, cols)}</div>`
    ),
    q("mul","integer","mult",
      `Multiply: <b>${a} √ó ${b}</b>`,
      `Break ${b} into tens and ones: (tens + ones).`,
      `Use distributive property. Answer: ${ans2}.`,
      Checkers.integer(ans2)
    )
  ];
}

function genDiv(r){
  const divisor = pick(r, [3,4,5,6,7,8,9,12]);
  const q0 = rInt(r, 20, 140);
  const n = divisor*q0 + pick(r,[0,1,2,3,4,5]);
  const quotient = Math.floor(n/divisor);
  const rem = n - quotient*divisor;
  return [
    q("quo","integer","div",
      `Divide: <b>${n} √∑ ${divisor}</b> ‚Äî quotient only.`,
      `How many groups of ${divisor} fit?`,
      `${divisor}√ó${quotient}=${quotient*divisor}, remainder ${rem}.`,
      Checkers.integer(quotient)
    ),
    q("rem","integer","div",
      `Same problem: remainder only.`,
      `Remainder is what's left after groups.`,
      `Remainder: ${rem}.`,
      Checkers.integer(rem)
    )
  ];
}

function genWord(r){
  const type = pick(r, ["mult","add","div"]);
  if(type==="mult"){
    const rows = rInt(r, 3, 10);
    const per = rInt(r, 6, 18);
    const ans = rows*per;
    return [ q("wp","integer","word",
      `Kaylyn has <b>${rows}</b> boxes with <b>${per}</b> stickers each. Total stickers?`,
      `Total = groups √ó each group.`,
      `${rows}√ó${per}=${ans}.`,
      Checkers.integer(ans)
    ) ];
  }
  if(type==="add"){
    const a = rInt(r, 120, 980);
    const b = rInt(r, 120, 980);
    const ans = a+b;
    return [ q("wp","integer","word",
      `A library had <b>${a}</b> books and got <b>${b}</b> more. How many now?`,
      `More means add.`,
      `${a}+${b}=${ans}.`,
      Checkers.integer(ans)
    ) ];
  }
  const total = rInt(r, 60, 220);
  const groups = pick(r, [3,4,5,6,8,9,10,11,12]);
  const qt = Math.floor(total/groups);
  const rem = total - qt*groups;
  return [ q("wp","text","word",
    `<b>${total}</b> cookies shared among <b>${groups}</b> kids. Write ‚Äúq r‚Äù. Example: 7 r 2`,
    `Quotient is how many each; remainder is leftovers.`,
    `${total}√∑${groups}=${qt} remainder ${rem} ‚Üí "${qt} r ${rem}".`,
    (raw)=>{
      const t = String(raw??"").trim().toLowerCase().replace(/\s+/g," ");
      const ok = t === `${qt} r ${rem}` || t === `${qt}r${rem}` || t === `${qt} remainder ${rem}` || t === `${qt} rem ${rem}`;
      return ok ? {ok:true} : {ok:false,msg:`Try: ${qt} r ${rem}`};
    }
  ) ];
}

function genEstimate(r){
  const a = rInt(r, 40, 990);
  const b = rInt(r, 40, 990);
  const a10 = Math.round(a/10)*10;
  const b10 = Math.round(b/10)*10;
  const est = a10 + b10;
  const exact = a + b;
  return [
    q("est","integer","estimate",
      `Estimate: round <b>${a}</b> and <b>${b}</b> to nearest 10, then add.`,
      `${a}‚âà${a10}, ${b}‚âà${b10}.`,
      `${a10}+${b10}=${est}.`,
      Checkers.integer(est)
    ),
    q("exact","integer","estimate",
      `Now compute exact: <b>${a}+${b}</b>.`,
      `Exact addition.`,
      `Exact: ${exact}.`,
      Checkers.integer(exact)
    )
  ];
}

function genTime(r){
  const h1 = rInt(r,1,11);
  const m1 = pick(r,[0,10,15,20,30,40,45,50]);
  const addMin = pick(r,[15,20,25,30,35,40,45,50,60,75,90,105]);
  const start = h1*60+m1;
  const end = start + addMin;
  const h2 = Math.floor((end/60)%12) || 12;
  const m2 = end%60;
  const fmt = (h,m)=>`${h}:${String(m).padStart(2,'0')}`;
  return [ q("elapsed","text","time",
    `Starting at <b>${fmt(h1,m1)}</b>, add <b>${addMin}</b> minutes. What time? (h:mm)`,
    `Add minutes, carry to next hour.`,
    `${fmt(h2,m2)}.`,
    (raw)=> String(raw??"").trim() === fmt(h2,m2) ? {ok:true} : {ok:false,msg:"Check h:mm format and carry minutes."}
  ) ];
}

function genMoney(r){
  const cost = pick(r,[1.25, 2.40, 3.75, 4.10, 5.60, 6.95, 7.30, 8.45]);
  const paid = pick(r,[10,20]);
  const change = Number((paid - cost).toFixed(2));
  return [ q("change","number","money",
    `Something costs <b>$${cost.toFixed(2)}</b>. You pay <b>$${paid.toFixed(2)}</b>. Change?`,
    `Change = paid ‚àí cost.`,
    `$${paid.toFixed(2)} ‚àí $${cost.toFixed(2)} = $${change.toFixed(2)}.`,
    Checkers.number(change, 0.00001)
  ) ];
}

function genFracIntro(r){
  const den = pick(r,[2,3,4,5,6,8,10,12]);
  const num = rInt(r,1,den-1);
  const val = num/den;
  return [ q("decimal","number","frac_intro",
    `What is <b>${num}/${den}</b> as a decimal?`,
    `Divide numerator by denominator.`,
    `${num}/${den} = ${val}.`,
    (raw)=>{
      const t=String(raw??"").trim(); if(!t) return {ok:false,msg:"Enter a decimal."};
      const n=Number(t); if(!Number.isFinite(n)) return {ok:false,msg:"Enter a number."};
      return Math.abs(n-val)<=0.02 ? {ok:true} : {ok:false,msg:"Try dividing num by den."};
    },
    `<div class="viz">${svgFractionBar(num,den)}</div>`
  ) ];
}

function genFracEquiv(r){
  const base = pick(r, [[1,2],[1,3],[2,3],[3,4],[2,5],[3,5],[4,6],[3,8]]);
  const k = pick(r,[2,3,4,5]);
  const n = base[0]*k, d = base[1]*k;
  return [
    q("simpN","integer","frac_equiv",
      `Simplify <b>${n}/${d}</b>. Enter the numerator.`,
      `Divide top and bottom by the same number.`,
      `Divide by ${k} ‚Üí ${base[0]}/${base[1]}.`,
      Checkers.integer(base[0]),
      `<div class="viz">${svgFractionBar(n,d)}</div>`
    ),
    q("simpD","integer","frac_equiv",
      `Simplify <b>${n}/${d}</b>. Enter the denominator.`,
      `Same division as numerator.`,
      `Divide by ${k}.`,
      Checkers.integer(base[1])
    )
  ];
}

function genFracComp(r){
  const fr = pick(r, [
    [[3,4],[5,8]],
    [[2,3],[3,5]],
    [[4,6],[3,4]],
    [[5,6],[7,9]],
    [[3,8],[2,5]],
    [[7,8],[5,6]],
  ]);
  const A = fr[0], B = fr[1];
  const vA = A[0]/A[1], vB = B[0]/B[1];
  const correct = vA > vB ? "A" : "B";
  return [ q("bigger","mcq","frac_comp",
    `Which is bigger? <b>A=${A[0]}/${A[1]}</b> or <b>B=${B[0]}/${B[1]}</b>`,
    `Compare to 1 or cross-multiply.`,
    `A‚âà${vA.toFixed(3)}, B‚âà${vB.toFixed(3)} ‚Üí ${correct} is bigger.`,
    null,
    null,
    ["A","B"],
    correct==="A" ? 0 : 1
  ) ];
}

function genArea(r){
  const w = rInt(r, 3, 14);
  const h = rInt(r, 3, 14);
  const area = w*h;
  const per = 2*(w+h);
  return [
    q("area","integer","area",
      `Rectangle <b>${w}√ó${h}</b>: Area = ?`,
      `Area = length√ówidth.`,
      `${w}√ó${h}=${area}.`,
      Checkers.integer(area)
    ),
    q("per","integer","area",
      `Rectangle <b>${w}√ó${h}</b>: Perimeter = ?`,
      `Perimeter = 2(w+h).`,
      `2(${w}+${h})=${per}.`,
      Checkers.integer(per)
    )
  ];
}

function genGeo(r){
  const angle = pick(r, [30,45,60,75,90,120,135,150]);
  const type = angle<90 ? "acute" : angle===90 ? "right" : "obtuse";
  return [ q("angle","mcq","geo",
    `An angle of <b>${angle}¬∞</b> is‚Ä¶`,
    `Acute < 90, Right = 90, Obtuse > 90.`,
    `${angle}¬∞ is ${type}.`,
    null,
    null,
    ["acute","right","obtuse"],
    type==="acute"?0:type==="right"?1:2
  ) ];
}

function genData(r){
  const vals = [rInt(r,2,9), rInt(r,2,9), rInt(r,2,9), rInt(r,2,9)];
  const labels = ["Apples","Oranges","Bananas","Grapes"];
  const max = Math.max(...vals);
  const idx = vals.indexOf(max);
  return [ q("chart","mcq","data",
    `Chart counts: ${labels.map((l,i)=>`<b>${l}</b> ${vals[i]}`).join(" ‚Ä¢ ")}. Greatest?`,
    `Greatest means largest number.`,
    `${labels[idx]} has ${max}.`,
    null,
    null,
    labels,
    idx
  ) ];
}

function genAlg(r){
  const x = rInt(r, 8, 80);
  const add = rInt(r, 4, 30);
  const eq = x+add;
  return [ q("box","integer","alg",
    `Solve: <b>‚ñ° + ${add} = ${eq}</b>. Enter ‚ñ°.`,
    `Undo + by subtracting.`,
    `${eq}‚àí${add}=${x}.`,
    Checkers.integer(x)
  ) ];
}

function genReview(r){
  const pool = [genAddSub, genMult, genDiv, genFracEquiv, genArea, genAlg];
  return pick(r, pool)(r);
}

function genChallenge(r){
  const rows = pick(r,[2,3,4]);
  const cols = pick(r,[3,4,5]);
  const rects = (rows*(rows+1)/2) * (cols*(cols+1)/2);
  return [ q("rects","integer","challenge",
    `How many rectangles in a <b>${rows}√ó${cols}</b> grid of squares?`,
    `Formula: (r(r+1)/2)√ó(c(c+1)/2).`,
    `(${rows}√ó${rows+1}/2)√ó(${cols}√ó${cols+1}/2) = ${rects}.`,
    Checkers.integer(rects)
  ) ];
}

function genTeach(r){
  return [ q("teach","text","teach",
    `Teach-back: Explain a strategy you used today in 2‚Äì5 sentences.`,
    `Start with: ‚ÄúFirst I‚Ä¶ Then I‚Ä¶‚Äù`,
    `Clear explanation is the goal.`,
    (raw)=> String(raw??"").trim().length>=25 ? ({ok:true}) : ({ok:false,msg:"Write at least 2 sentences."})
  ) ];
}

function genCapstone(r){
  return [
    q("create","text","capstone",
      `Capstone: Write your own word problem (1‚Äì2 sentences).`,
      `Include numbers and a clear question.`,
      `Original problem required.`,
      (raw)=> String(raw??"").trim().length>=25 ? ({ok:true}) : ({ok:false,msg:"Write 1‚Äì2 full sentences."})
    ),
    q("solve","text","capstone",
      `Capstone: Solve your problem with steps (2‚Äì6 sentences).`,
      `Show operation + why.`,
      `Explain steps.`,
      (raw)=> String(raw??"").trim().length>=35 ? ({ok:true}) : ({ok:false,msg:"Write at least 2‚Äì3 sentences with steps."})
    )
  ];
}

const WeekGenerators = [
  genFlex, genPatterns, genAddSub, genMult, genDiv,
  genWord, genEstimate, genTime, genMoney, genFracIntro,
  genFracEquiv, genFracComp, genArea, genGeo, genData,
  genAlg, genReview, genChallenge, genTeach, genCapstone
];

/* ---------- Build questions for week (10 per week) ---------- */
function questionsForWeek(i, seedStr){
  const seed = seedStr || weekSeed(i);
  const r = seededRand(seed);
  const gen = WeekGenerators[i] || genFlex;
  let qs = [];

  // main generator yields 1‚Äì2
  qs = qs.concat(gen(r));

  // top up with review/challenge to reach 10
  while(qs.length < 10){
    const extra = (i < 10) ? genReview(r) : (r() < 0.65 ? genReview(r) : genChallenge(r));
    qs = qs.concat(extra);
  }

  // ensure unique IDs by appending an index
  qs = qs.slice(0,10).map((qq, idx)=>({ ...qq, uid: qq.id + "_" + idx }));
  return qs;
}

function weekCompletion(i){
  const ws = weekState(i);
  const qs = questionsForWeek(i, weekSeed(i));
  let correct=0, attempted=0;
  for(const q of qs){
    const a = ws.attempts[q.uid];
    if(a && a.tries>0) attempted++;
    if(a && a.status==="correct") correct++;
  }
  return { correct, attempted, total: qs.length, done: correct===qs.length && qs.length>0 };
}

/* ---------- UI refs ---------- */
const weekListEl = document.getElementById("weekList");
const doneLabel = document.getElementById("doneLabel");
const xpLabel = document.getElementById("xpLabel");
const streakLabel = document.getElementById("streakLabel");
const progressBar = document.getElementById("progressBar");

const pathLabel = document.getElementById("pathLabel");
const titleLabel = document.getElementById("titleLabel");
const descLabel = document.getElementById("descLabel");
const skillLabel = document.getElementById("skillLabel");
const masteryLabel = document.getElementById("masteryLabel");
const seedLabel = document.getElementById("seedLabel");
const weekStatus = document.getElementById("weekStatus");
const qWrap = document.getElementById("qWrap");

const explainCard = document.getElementById("explainCard");
const explainBox = document.getElementById("explainBox");
const explainSaved = document.getElementById("explainSaved");
const saveExplainBtn = document.getElementById("saveExplainBtn");

const quizCard = document.getElementById("quizCard");
const quizTime = document.getElementById("quizTime");
const quizScore = document.getElementById("quizScore");
const quizStartBtn = document.getElementById("quizStartBtn");

const dashboard = document.getElementById("dashboard");
const dashStats = document.getElementById("dashStats");
const dashWeak = document.getElementById("dashWeak");

const newSetBtn = document.getElementById("newSetBtn");
const exportBtn = document.getElementById("exportBtn");
const importBtn = document.getElementById("importBtn");
const resetBtn = document.getElementById("resetBtn");

const courseBtn = document.getElementById("courseBtn");
const dailyBtn = document.getElementById("dailyBtn");
const quizBtn = document.getElementById("quizBtn");
const dashboardBtn = document.getElementById("dashboardBtn");

/* ---------- Top stats ---------- */
function updateTop(){
  let done = 0;
  for(let i=0;i<Weeks.length;i++){
    if(weekCompletion(i).done) done++;
  }
  doneLabel.textContent = `${done}/${Weeks.length}`;
  xpLabel.textContent = `${state.totalXp||0}`;
  streakLabel.textContent = `${state.streak||0}`;
  progressBar.style.width = `${Math.round((done/Weeks.length)*100)}%`;
}

/* ---------- Parent dashboard ---------- */
function renderDashboard(){
  const correct = state.events.filter(e=>e.type==="answer" && e.detail?.ok===true).length;
  const wrong = state.events.filter(e=>e.type==="answer" && e.detail?.ok===false).length;
  const acc = (correct+wrong) ? Math.round((correct/(correct+wrong))*100) : 0;

  dashStats.innerHTML = "";
  [
    ["Total attempts", String(correct+wrong)],
    ["Accuracy", acc + "%"],
    ["Best streak", String(state.streakBest||0)],
    ["XP", String(state.totalXp||0)],
  ].forEach(([k,v])=>{
    const el = document.createElement("div");
    el.className = "pill";
    el.innerHTML = `${k}: <strong>${v}</strong>`;
    dashStats.appendChild(el);
  });

  const skills = Weeks.map(w=>w.skill);
  const rows = skills.map(s=>{
    const m = getMastery(s);
    return { s, lvl: m.level||0, xp: m.xp||0 };
  }).sort((a,b)=> a.lvl-b.lvl || a.xp-b.xp);

  const weak = rows.slice(0,6).map(r=>`${r.s} (L${r.lvl}, XP ${r.xp})`).join(" ‚Ä¢ ");
  dashWeak.textContent = "Weakest skills: " + (weak || "No data yet.");
}

/* ---------- Adaptive selection ---------- */
function weakestWeekIndex(){
  let bestIdx = 0;
  let best = null;
  for(let i=0;i<Weeks.length;i++){
    const sk = Weeks[i].skill;
    const m = getMastery(sk);
    const cand = { i, lvl:m.level||0, xp:m.xp||0 };
    if(!best || cand.lvl < best.lvl || (cand.lvl===best.lvl && cand.xp < best.xp)){
      best = cand; bestIdx = i;
    }
  }
  return bestIdx;
}

/* ---------- Mini-Quiz ---------- */
let quizTimer = null;
function fmtTime(ms){
  const s = Math.max(0, Math.floor(ms/1000));
  const m = Math.floor(s/60);
  const ss = String(s%60).padStart(2,'0');
  return `${m}:${ss}`;
}
function startQuiz(){
  state.mode = "quiz";
  state.quiz.active = true;
  state.quiz.startedAt = now();
  state.quiz.score = 0;
  state.quiz.total = 10;
  state.quiz.seed = quizSeed();
  saveState();
  render();
  if(quizTimer) clearInterval(quizTimer);
  quizTimer = setInterval(()=>{
    if(state.mode!=="quiz" || !state.quiz.active) return;
    quizTime.textContent = fmtTime(now() - state.quiz.startedAt);
  }, 250);
}

/* ---------- Rendering ---------- */
function render(){
  // left list: weeks + daily/quiz entry
  weekListEl.innerHTML = "";

  // Mode header ‚Äúcards‚Äù
  const modeCard = (title, sub, active, onClick) => {
    const b = document.createElement("button");
    b.className = "wkBtn" + (active ? " active" : "");
    b.innerHTML = `
      <div class="wkLeft">
        <div class="wkTitle">${title}</div>
        <div class="wkSub">${sub}</div>
      </div>
      <div class="wkRight">
        <div class="badge ${active ? "ip":""}">${active ? "Active" : "Open"}</div>
      </div>
    `;
    b.addEventListener("click", onClick);
    weekListEl.appendChild(b);
  };

  modeCard("Daily Practice", "Fresh mixed set every day (weak-skill focused).", state.mode==="daily", ()=>{
    state.mode="daily"; saveState(); render();
  });
  modeCard("Mini-Quiz", "10 questions ‚Ä¢ timed ‚Ä¢ score.", state.mode==="quiz", ()=>{
    state.mode="quiz"; saveState(); render();
  });
  modeCard("Course Weeks", "20-week track with mastery.", state.mode==="course", ()=>{
    state.mode="course"; saveState(); render();
  });

  // Week cards (only ‚Äúcourse‚Äù shows as primary list but still visible)
  for(let i=0;i<Weeks.length;i++){
    const wk = Weeks[i];
    const comp = weekCompletion(i);
    const m = getMastery(wk.skill);
    const mb = masteryBadge(m.level||0);

    const btn = document.createElement("button");
    btn.type="button";
    btn.className = "wkBtn" + ((state.mode==="course" && i===state.currentWeek) ? " active" : "");
    btn.innerHTML = `
      <div class="wkLeft">
        <div class="wkTitle">${wk.title}</div>
        <div class="wkSub">${wk.desc}</div>
      </div>
      <div class="wkRight">
        <div class="badge ${comp.done ? "done" : (comp.attempted ? "ip" : "")}">
          ${comp.done ? "‚úì Done" : (comp.attempted ? `${comp.correct}/${comp.total}` : "Not started")}
        </div>
        <div class="badge ${mb.cls}">${mb.text}</div>
      </div>
    `;
    btn.addEventListener("click", ()=>{
      state.mode="course";
      state.currentWeek = i;
      saveState();
      render();
    });
    weekListEl.appendChild(btn);
  }

  // Main panel header
  let mode = state.mode || "course";
  quizCard.style.display = (mode==="quiz") ? "block" : "none";
  dashboard.style.display = "none";

  let wkIndex = state.currentWeek;
  let seed = "";
  let title = "";
  let desc = "";
  let skill = "";
  let qs = [];

  if(mode==="course"){
    const wk = Weeks[wkIndex];
    seed = weekSeed(wkIndex);
    title = wk.title;
    desc = wk.desc;
    skill = wk.skill;
    qs = questionsForWeek(wkIndex, seed);
  } else if(mode==="daily"){
    // daily: mix weak skills by picking 10 questions from weakest weeks
    seed = dailySeed();
    title = "Daily Practice";
    desc = "Mixed set generated from weakest skills (changes daily).";
    const r = seededRand(seed);
    const picks = [];
    for(let k=0;k<10;k++){
      const wi = (r() < 0.75) ? weakestWeekIndex() : rInt(r, 0, Weeks.length-1);
      const local = questionsForWeek(wi, `${seed}-w${wi}-k${k}`);
      picks.push(pick(r, local));
    }
    qs = picks.map((qq, idx)=>({ ...qq, uid: `daily_${idx}_${qq.uid}`, skillId: qq.skillId || Weeks[weakestWeekIndex()].skill }));
    skill = "mixed";
  } else { // quiz
    seed = state.quiz.seed || quizSeed();
    title = "Mini-Quiz";
    desc = "10 questions, timed. Press Start to generate.";
    skill = "mixed";
    if(state.quiz.active){
      const r = seededRand(seed);
      const picks = [];
      for(let k=0;k<10;k++){
        const wi = (r() < 0.70) ? weakestWeekIndex() : rInt(r, 0, Weeks.length-1);
        const local = questionsForWeek(wi, `${seed}-w${wi}-k${k}`);
        picks.push(pick(r, local));
      }
      qs = picks.map((qq, idx)=>({ ...qq, uid: `quiz_${idx}_${qq.uid}` }));
    } else {
      qs = [];
    }
  }

  pathLabel.textContent = mode==="course" ? "Course" : mode==="daily" ? "Daily Practice" : "Mini-Quiz";
  titleLabel.textContent = title;
  descLabel.textContent = desc;

  skillLabel.textContent = skill;
  seedLabel.textContent = seed.replaceAll("-", " ¬∑ ");

  // mastery label
  if(mode==="course"){
    const m = getMastery(Weeks[wkIndex].skill);
    const mb = masteryBadge(m.level||0);
    masteryLabel.textContent = `${mb.text} (XP ${m.xp||0})`;
  } else {
    masteryLabel.textContent = "‚Äî";
  }

  // explain card only for course weeks
  explainCard.style.display = (mode==="course") ? "block" : "none";
  if(mode==="course"){
    const ws = weekState(wkIndex);
    explainBox.value = ws.explain || "";
    explainSaved.textContent = (ws.explain && ws.explain.trim()) ? "Saved ‚úì" : "Not saved";
    explainSaved.style.color = (ws.explain && ws.explain.trim()) ? "rgba(52,211,153,.95)" : "var(--muted)";
    // week status
    const comp = weekCompletion(wkIndex);
    weekStatus.className = "badge " + (comp.done ? "done" : comp.attempted ? "ip" : "");
    weekStatus.textContent = comp.done ? "‚úì Week complete" : comp.attempted ? `${comp.correct}/${comp.total} correct` : "Not started";
  } else {
    weekStatus.className = "badge";
    weekStatus.textContent = mode==="daily" ? "Daily set" : (state.quiz.active ? "Quiz running" : "Quiz not started");
  }

  // quiz header
  if(mode==="quiz"){
    quizTime.textContent = state.quiz.active ? fmtTime(now() - state.quiz.startedAt) : "0:00";
    quizScore.textContent = `${state.quiz.score||0}/${state.quiz.total||10}`;
  }

  // render questions
  qWrap.innerHTML = "";
  qs.forEach((qq, idx)=>{
    const card = document.createElement("div");
    card.className = "q";

    const metaSkill = qq.skillId || "mixed";
    const top = document.createElement("div");
    top.className = "qTop";
    top.innerHTML = `
      <div>
        <div class="qTitle">${qq.prompt}</div>
        <div class="qMeta">Skill <b>${metaSkill}</b> ‚Ä¢ Q${idx+1}/${qs.length}</div>
      </div>
      <div class="badge">‚Äî</div>
    `;

    const body = document.createElement("div");
    body.style.marginTop = "10px";

    const feedback = document.createElement("div");
    feedback.className = "feedback";

    const hint = document.createElement("div");
    hint.className = "hint";
    hint.textContent = qq.hint || "";

    // visuals
    if(qq.vizHtml){
      const viz = document.createElement("div");
      viz.className = "viz";
      viz.innerHTML = qq.vizHtml;
      body.appendChild(viz);
    }

    let getValue = () => "";
    let attemptKey = qq.uid;

    // MCQ
    if(qq.type === "mcq"){
      const optGrid = document.createElement("div");
      optGrid.className = "optGrid";
      let selected = null;

      qq.options.forEach((label, i)=>{
        const b = document.createElement("button");
        b.type="button";
        b.className = "opt";
        b.textContent = label;
        b.addEventListener("click", ()=>{
          selected = i;
          [...optGrid.children].forEach((c, idx2)=>c.classList.toggle("sel", idx2===i));
        });
        optGrid.appendChild(b);
      });
      body.appendChild(optGrid);
      getValue = ()=> selected==null ? "" : String(selected);
    } else {
      const input = document.createElement("input");
      input.type = (qq.type==="number") ? "number" : "text";
      input.placeholder = (qq.type==="expr") ? "Try: (5+7)*2  or  8x3x1" : "Type answer‚Ä¶";
      body.appendChild(input);
      getValue = ()=> input.value;
    }

    const row = document.createElement("div");
    row.className = "row";

    const checkBtn = document.createElement("button");
    checkBtn.className = "btn primary";
    checkBtn.textContent = "Check";

    const hintBtn = document.createElement("button");
    hintBtn.className = "btn ghost";
    hintBtn.textContent = "Hint";

    const stepsBtn = document.createElement("button");
    stepsBtn.className = "btn ghost";
    stepsBtn.textContent = "Show steps";
    stepsBtn.style.display = "none";

    hintBtn.addEventListener("click", ()=>{
      hint.style.display = (hint.style.display==="block") ? "none" : "block";
    });
    stepsBtn.addEventListener("click", ()=>{
      feedback.className = "feedback warn";
      feedback.textContent = qq.solution || "No solution available.";
      feedback.style.display = "block";
    });

    function setFeedback(kind, msg){
      feedback.className = "feedback " + kind;
      feedback.textContent = msg;
      feedback.style.display = "block";
    }

    // attempts are tracked per-mode lightly (course saves per-week; daily/quiz not persisted as ‚Äúweek progress‚Äù)
    let tries = 0;
    function markCorrect(){
      top.querySelector(".badge").className = "badge done";
      top.querySelector(".badge").textContent = "‚úì Correct";
    }
    function markProgress(){
      top.querySelector(".badge").className = "badge ip";
      top.querySelector(".badge").textContent = "In progress";
    }

    function check(){
      tries++;
      const raw = getValue();

      let res = { ok:false, msg:"Try again." };

      // MCQ
      if(qq.type==="mcq"){
        const idx = Number(raw);
        if(Number.isNaN(idx)) res = { ok:false, msg:"Choose an option." };
        else res = (idx === qq.correctIndex) ? { ok:true } : { ok:false, msg:"Not quite. Try again." };
      } else if(qq.type==="text"){
        if(qq.checker) res = qq.checker(raw);
        else res = String(raw??"").trim().length>=15 ? { ok:true } : { ok:false, msg:"Write a little more." };
      } else {
        res = qq.checker ? qq.checker(raw) : { ok:false, msg:"No checker." };
      }

      logEvent("answer", { ok: !!res.ok, skill: metaSkill, mode });

      if(res.ok){
        markCorrect();
        setFeedback("good", "Correct ‚úÖ");
        award(metaSkill, true);

        // quiz scoring
        if(mode==="quiz" && state.quiz.active){
          state.quiz.score = (state.quiz.score||0) + 1;
          quizScore.textContent = `${state.quiz.score}/${state.quiz.total||10}`;
          // end quiz when all answered (simple: score counts correct only; user can still attempt others)
        }

        if(tries===1) popConfetti();
      } else {
        markProgress();
        award(metaSkill, false);

        // smarter feedback for expr target
        if(qq.type==="expr"){
          const norm = normalizeExpr(raw);
          const used = norm ? countNumbersInExpr(norm) : 0;
          if(used===0){
            setFeedback("bad", "Type an expression like (5+7)*2 or 8x3x1.");
          } else {
            setFeedback("bad", res.msg || "Try again.");
          }
        } else {
          setFeedback("bad", res.msg || "Try again.");
        }

        if(tries>=1) hint.style.display="block";
        if(tries>=2) stepsBtn.style.display="inline-block";
      }

      saveState();
      updateTop();
    }

    checkBtn.addEventListener("click", check);

    row.appendChild(checkBtn);
    row.appendChild(hintBtn);
    row.appendChild(stepsBtn);

    card.appendChild(top);
    card.appendChild(body);
    card.appendChild(row);
    card.appendChild(feedback);
    card.appendChild(hint);
    qWrap.appendChild(card);
  });

  updateTop();
}

/* ---------- Buttons & actions ---------- */
newSetBtn.addEventListener("click", ()=>{
  if(state.mode==="course"){
    const ws = weekState(state.currentWeek);
    ws.setCounter = (ws.setCounter||0) + 1;
    ws.attempts = {};
    saveState();
  }
  if(state.mode==="quiz"){
    startQuiz();
    return;
  }
  render();
});

courseBtn.addEventListener("click", ()=>{ state.mode="course"; saveState(); render(); });
dailyBtn.addEventListener("click", ()=>{ state.mode="daily"; saveState(); render(); });
quizBtn.addEventListener("click", ()=>{ state.mode="quiz"; saveState(); render(); });
dashboardBtn.addEventListener("click", ()=>{
  dashboard.style.display = (dashboard.style.display==="none") ? "block" : "none";
  if(dashboard.style.display==="block") renderDashboard();
});

quizStartBtn.addEventListener("click", startQuiz);

saveExplainBtn.addEventListener("click", ()=>{
  if(state.mode!=="course") return;
  const ws = weekState(state.currentWeek);
  ws.explain = explainBox.value;
  saveState();
  explainSaved.textContent = "Saved ‚úì";
  explainSaved.style.color = "rgba(52,211,153,.95)";
});

exportBtn.addEventListener("click", ()=>{
  const data = JSON.stringify(state, null, 2);
  const blob = new Blob([data], { type:"application/json" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "kaylyn-math-studio-progress.json";
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
});

importBtn.addEventListener("click", ()=>{
  const input = document.createElement("input");
  input.type = "file";
  input.accept = "application/json";
  input.onchange = async () => {
    const file = input.files && input.files[0];
    if(!file) return;
    try{
      const text = await file.text();
      const obj = JSON.parse(text);
      state = { ...defaultState(), ...obj };
      saveState();
      applyTheme();
      render();
      alert("Imported ‚úì");
    }catch{
      alert("Import failed. Use an exported JSON file.");
    }
  };
  input.click();
});

resetBtn.addEventListener("click", ()=>{
  if(!confirm("Reset ALL progress on this device?")) return;
  state = defaultState();
  saveState();
  applyTheme();
  render();
});

/* ---------- Boot ---------- */
render();
</script>
</body>
</html>
